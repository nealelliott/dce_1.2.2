# @OSF_COPYRIGHT@
# COPYRIGHT NOTICE
# Copyright (c) 1990, 1991, 1992, 1993, 1996 Open Software Foundation, Inc.
# ALL RIGHTS RESERVED (DCE).  See the file named COPYRIGHT.DCE in the
# src directory for the full copyright text.
#
# (c) Copyright 1991, 1992 
#     Siemens-Nixdorf Information Systems, Burlington, MA, USA
#     All Rights Reserved
#
# HISTORY
# $Log: Makefile,v $
# Revision 1.2.24.2  1996/10/15  20:46:47  arvind
# 	Change for international build
# 	[1996/10/07  19:27 UTC  arvind  /main/arvind_work/2]
#
# 	Update OSF copyright year
# 	[1996/03/09  22:42:02  marty]
#
# 	ENDGAME Submission
# 	[1996/02/22  16:10:54  root]
#
# 	Submit OSF/DCE 1.2.1
# 	HP 	[1995/11/16  21:29 UTC  jrr  /main/HPDCE02/gaz_dce_instr/jrr_1.2_mothra/1]
#
# 	Remove some Mothra specific stuff.
# 	HP 	[1995/07/20  18:31 UTC  gaz  /main/HPDCE02/gaz_dce_instr/2]
#
# 	Remove define of 'USE_GETTIMEOFDAY' to header files
# 	HP 	[1995/07/15  20:17 UTC  gaz  /main/HPDCE02/gaz_dce_instr/1]
#
# 	cause server stubs to be compiled with instrumentation
# 	HP 	[1995/01/16  19:14 UTC  markar  /main/HPDCE02/5]
#
# 	Merging Local RPC mods
# 	HP 	[1995/01/05  16:03 UTC  markar  /main/HPDCE02/markar_local_rpc/1]
#
# 	Implementing Local RPC bypass mechanism
# 	HP 	[1994/12/23  00:25 UTC  kline_s  /main/HPDCE02/4]
#
# 	Enable RPC I18N functionality
# 	HP 	[1994/12/22  21:38 UTC  kline_s  /main/HPDCE02/kline_s_mothra_latest/1]
#
# 	Add dce_langinfo() to object list.
# 	HP 	[1994/09/21  15:11 UTC  tatsu_s  /main/HPDCE02/3]
#
# 	Fixed DES_HIDDEN build.
# 	HP 	[1994/09/21  14:50 UTC  tatsu_s  /main/HPDCE02/2]
#
# 	Merged mothra up to dce1_1_b18.
# 	[1995/12/07  23:57:00  root]
#
# 	Merged mothra up to dce 1.1.
# 	[1993/10/05  19:59:01  tatsu_s  1.1.12.5]
#
# 	Loading drop DCE1_0_3b931005
# 	[1993/09/20  18:00:47  tatsu_s  1.1.12.4]
#
# Revision 1.2.24.1  1996/05/10  13:08:46  arvind
# 	Drop 1 of DCE 1.2.2 to OSF
# 
# 	HP revision /main/DCE_1.2/2  1996/03/14  19:10 UTC  psn
# 	Merge OSF endgame fixes to HP.
# 
# 	HP revision /main/DCE_1.2/psn_1.2_endgame/1  1996/02/28  21:53 UTC  psn
# 	Fix OT13343 as done during OSF 1.2.1 Endgame.
# 
# 	HP revision /main/DCE_1.2/1  1996/01/03  18:57 UTC  psn
# 	Remove some Mothra specific stuff.
# 	[1995/11/16  21:29 UTC  jrr  /main/HPDCE02/gaz_dce_instr/jrr_1.2_mothra/1]
# 
# 	Remove define of 'USE_GETTIMEOFDAY' to header files
# 	[1995/07/20  18:31 UTC  gaz  /main/HPDCE02/gaz_dce_instr/2]
# 
# 	cause server stubs to be compiled with instrumentation
# 	[1995/07/15  20:17 UTC  gaz  /main/HPDCE02/gaz_dce_instr/1]
# 
# 	Merging Local RPC mods
# 	[1995/01/16  19:14 UTC  markar  /main/HPDCE02/5]
# 
# 	Implementing Local RPC bypass mechanism
# 	[1995/01/05  16:03 UTC  markar  /main/HPDCE02/markar_local_rpc/1]
# 
# 	Enable RPC I18N functionality
# 	[1994/12/23  00:25 UTC  kline_s  /main/HPDCE02/4]
# 
# 	Add dce_langinfo() to object list.
# 	[1994/12/22  21:38 UTC  kline_s  /main/HPDCE02/kline_s_mothra_latest/1]
# 
# 	Fixed DES_HIDDEN build.
# 	[1994/09/21  15:11 UTC  tatsu_s  /main/HPDCE02/3]
# 
# 	Merged mothra up to dce1_1_b18.
# 	[1994/09/21  14:50 UTC  tatsu_s  /main/HPDCE02/2]
# 
# 	CR # 11497 - Remove '-v' option from IDLFLAGS defineittion.
# 	[1994/09/06  21:39:31  marty]
# 	#
# 
# 	Merged mothra up to dce 1.1.
# 	[1994/08/03  16:34 UTC  tatsu_s  /main/HPDCE02/1]
# 
# 	Merged up to DCE1_0_3b931005.
# 	#
# 	Added the build rule for libnck.sl
# 	[1993/07/28  15:51:47  tatsu_s]
# 	#
# 	Add changes for DES-hidden build.
# 	[1992/12/07  14:46:11  grober_j]
# 	#
# 
# 	Loading drop DCE1_0_3b931005
# 	[1993/10/05  17:59:01  tatsu_s  1.1.13.5]
# 
# 	KK merged upto DCE1_0_3b03.
# 	[1993/09/18  05:37:25  tatsu_s]
# 
# Revision 1.2.18.10  1994/09/07  15:48:34  marty
# 	CR # 11497 - Remove '-v' option from IDLFLAGS defineittion.
# 	[1994/09/06  21:39:31  marty]
# 
# Revision 1.2.18.9  1994/07/14  21:28:30  tom
# 	Remove NCS compat stuff.
# 	[1994/07/14  21:09:10  tom]
# 
# Revision 1.2.18.8  1994/06/29  20:55:23  ohara
# 	Merged with changes from 1.2.18.7
# 	[1994/06/29  20:55:12  ohara]
# 
# 	cs_s_stub.o not supported on SVR4 yet
# 	[1994/06/27  19:54:13  ohara]
# 
# Revision 1.2.18.7  1994/06/23  17:40:10  tom
# 	Add uuidsys.o since it now is mostly machine independant.
# 	[1994/06/22  20:40:33  tom]
# 
# Revision 1.2.18.6  1994/05/20  22:03:36  sommerfeld
# 	Merged with changes from 1.2.18.5
# 	[1994/05/20  22:02:50  sommerfeld]
# 
# 	Merge in Will's changes
# 	[1994/05/20  21:36:44  sommerfeld]
# 
# 	add dependancy on codesets.h for a few files.
# 	[1994/05/17  19:09:47  sommerfeld]
# 
# Revision 1.2.18.5  1994/05/19  21:14:16  hopkins
# 	Merge with DCE1_1.
# 	[1994/05/04  19:34:51  hopkins]
# 
# 	Serviceability:
# 	  Add OBJS_SVC to OFILES, remove rpcdbg.o
# 	  from OBJS_COMMON, add SVC_DEFS and rule
# 	  to build .c and .h files from rpc.sams.
# 	[1994/05/03  20:16:34  hopkins]
# 
# Revision 1.2.18.4  1994/02/09  21:06:50  mori_m
# 	CR 9912:  Moved machine dependent object (cs_s_conv.o) to rpc.mk
# 	[1994/02/09  21:06:38  mori_m]
# 
# Revision 1.2.18.3  1994/02/08  21:29:03  mori_m
# 	CR 9701:  Initial submission for RPC runtime I18N support
# 	[1994/02/08  21:28:48  mori_m]
# 
# Revision 1.2.18.2  1994/01/04  17:50:07  ohara
# 	fix include of machdep.mk for new make
# 	[1994/01/04  17:34:30  ohara]
# 
# Revision 1.2.18.1  1993/12/14  15:49:48  rsalz
# 	Remove dce_error.o; it is now in SVC library.
# 	[1993/12/14  15:49:40  rsalz]
# 
# Revision 1.2.13.1  1993/09/15  15:39:42  damon
# 	Synched with ODE 2.1 based build
# 	[1993/09/15  15:31:57  damon]
# 
# Revision 1.2.13.2  1993/09/14  16:47:37  tatsu_s
# 	Bug 8103 - Added comfork_cma.o into OBJS_COMMON.
# 	[1993/09/13  17:01:42  tatsu_s]
# 
# Revision 1.2.6.5  1993/01/03  22:57:00  bbelch
# 	Embedding copyright notice
# 	[1993/01/03  19:56:51  bbelch]
# 
# Revision 1.2.6.4  1992/12/23  20:10:01  zeliff
# 	Embedding copyright notice
# 	[1992/12/23  15:27:54  zeliff]
# 
# Revision 1.2.6.3  1992/10/02  19:37:02  markar
# 	  OT CR 2786 fix: Relocated information from rpc.mk to here
# 	[1992/09/22  18:48:47  markar]
# 
# Revision 1.2.6.2  1992/09/29  21:13:53  devsrc
# 	SNI/SVR4 merge.  OT 5373
# 	[1992/09/11  15:36:33  weisman]
# 
# Revision 1.2.2.7  1992/05/27  13:25:44  rec
# 	Removed -g option from the compile line.  Create a libdce that is too
# 	large for the current version of the OSF/1 langauge tools (linker).
# 	[1992/05/27  13:25:00  rec]
# 
# Revision 1.2.2.6  1992/05/22  18:56:54  wei_hu
# 	AUTH CN Code Drop (RPC6)
# 	[1992/05/22  18:41:40  wei_hu]
# 
# Revision 1.2.2.5  1992/05/11  17:51:19  mhickey
# 	Removed obsolete define of NEED_PROJECT_MAKE_DEFS
# 	and include of osf.dce.mk.  Fixes defect 2031.
# 	[1992/04/22  15:21:51  mhickey]
# 
# Revision 1.2.2.4  1992/05/06  20:10:46  weisman
# 	Correct typo for NOPping out CN/auth.
# 
# 	<AUTH_DEFS	?= -DAUTH_KRB -DUATH_KRB_DG
# 	>AUTH_DEFS	?= -DAUTH_KRB -DAUTH_KRB_DG
# 	[1992/05/06  20:10:24  weisman]
# 
# Revision 1.2.2.3  1992/05/01  18:37:04  rsalz
# 	"Changed as part of rpc6 drop."
# 	[1992/05/01  18:25:24  rsalz]
# 
# 	 10-mar-1992	pf	DCE V1.0.1 merge
# 	[1992/05/01  18:05:47  rsalz]
# 
# Revision 1.2  1992/01/19  22:13:39  devrcs
# 	Dropping DCE1.0 OSF1_misc port archive
# 
# $EndLog$
#
#
#
#  OSF DCE Version 1.0 
#
##
##  Copyright (c) 1991 by
##      Hewlett-Packard Company, Palo Alto, Ca. & 
##      Digital Equipment Corporation, Maynard, Mass.
##
##  NAME:
##
##      makefile.runtime (src/rpc/runtime/Makefile)
##
##  FACILITY:
##
##      Remote Procedure Call (RPC) 
##
##  ABSTRACT:
##
##  Makefile fragment for RPC runtime.
##
##
###########################################################
# define the following "globally" for the libdce.a build.
###########################################################
###  DO NOT PUT ANYTHING IN THIS SECTION EXCEPT FOR OBJECT
###  FILE LISTS!!!!!
###########################################################
#
libnck_OFILES=\
	${OBJS_COMMON} ${OBJS_SVC} ${OBJS_COM} \
	${OBJS_CN} ${OBJS_DG} \
	${OBJS_IP} ${OBJS_OSI} \
	${OBJS_MGMT} \
	${OBJS_NDR} \
	${OBJS_NOAUTH} ${OBJS_KRB} \
	${OBJS_NS} \
	${OBJS_CS} \
	$${OBJS_COMPAT} \
	${${TARGET_MACHINE}_libnck_OFILES}

libnck.a_OFILES = ${libnck_OFILES}

.if ${SITE} == "HP" && ${TARGET_OS} == "HPUX"
libnck.sl_OFILES = ${libnck_OFILES}
.endif	# SITE == "HP" && TARGET_OS == "HPUX"

.ifdef DES_HIDDEN

#
# Separate out the files which have to have
# entry points hidden for the DES-hidden libdce.
#
libnck_hide_OFILES = ${OBJS_KRB}

libnck_nohide_OFILES=\
	${OBJS_COMMON} ${OBJS_SVC} ${OBJS_COM} \
	${OBJS_CN} ${OBJS_DG} \
	${OBJS_IP} ${OBJS_OSI} \
	${OBJS_MGMT} \
	${OBJS_NDR} \
	${OBJS_NOAUTH} \
	${OBJS_NS} \
	${OBJS_CS} \
	$${OBJS_COMPAT} \
	${${TARGET_MACHINE}_libnck_OFILES}

.endif
#
# A logical division of the OFILES, by runtime subcomponent.
#
# Note that the variables are set up to allow sensible exclusion of
# subcomponents by doing things like "make OBJS_CN=".  Candidates for
# such exclusion are noted below.  Note that excluding subcomponents
# will sometimes also require modifications to one or more of the
# definitions of PROT_DEFS, AUTH_DEFS, or NAF_DEFS further below.
#

#
# Runtime common services.
#
OBJS_COMMON	= rpctimer.o rpcclock.o rpcdbg.o rpcmutex.o rpclist.o \
                  rpcmem.o rpclog.o rpcrand.o comfork_cma.o

#
# Serviceability
#
OBJS_SVC	= rpcsvc.o dcerpcmsg.o dcerpcsvc.o

#
# Common communication services.
#
OBJS_COM	= comauth.o combind.o comcall.o comcthd.o \
                  comif.o cominit.o cominit_ux.o comnaf.o comnet.o comobj.o \
		  comep.o comnlsn.o comtwr.o comtwrflr.o comtwrref.o \
                  comp.o comutil.o uuid.o uuidsys.o ep_cstub.o
#
# Implementation of RPC protocol for connection-oriented transports.
# Excludable if the PROT_NCACN cpp symbol is not defined (e.g., in the
# definition of PROT_DEFS below).
#
OBJS_CN		= cnassoc.o cnbind.o cncall.o cncasgsm.o cncassm.o cncclsm.o \
		  cncthd.o cnfbuf.o cnid.o cninit.o cnmgmt.o cnnet.o cnp.o \
		  cnpkt.o cnrcvr.o cnsasgsm.o cnsassm.o cnsclsm.o cnsm.o \
		  cnxfer.o
#
# Implementation of RPC protocol for connectionless transports.  Excludable
# if the PROT_NCADG cpp symbol is not defined (e.g., in the definition
# of PROT_DEFS below).
#
OBJS_DG		= conv.o dg.o dgcall.o dgccall.o dgccallt.o dgcct.o \
                  dgclive.o dgclsn.o dgexec.o dgfwd.o dgglob.o dghnd.o \
                  dginit.o dglossy.o dglsn.o dgpkt.o dgrq.o dgscall.o \
                  dgsct.o dgslive.o dgslsn.o dgsoc.o dgutl.o dgxq.o \
		  conv_cstub.o convc_cstub.o convc_sstub.o
#
# Implementation of IP (Internet Protocol) network address family support
# routines.  Excludable if the NAF_IP cpp symbol is not defined (e.g.,
# in the definition of NAF_DEFS below).
#
OBJS_IP		= ipnaf.o twr_ip.o 
#
# Implementation of DDS (Apollo DOMAIN) network address family support
# routines.  Excludable if the NAF_DDS cpp symbol is not defined (e.g.,
# in the definition of NAF_DEFS below).
#
OBJS_DDS	= dds.o twr_dds.o
#
# Latent support for OSI network address family.
#
OBJS_OSI	= twr_osi.o
#
# Implementation of RPC management functions.
#
OBJS_MGMT	= mgmt.o mgmt_cstub.o mgmt_sstub.o
#
# Implementation of NDR support needed by runtime.
#
OBJS_NDR	= ndrglob.o
#
# Implementation of the rpc_ns_... routines.  Excludable if these functions
# are not used (they're not used internally by the runtime).
#
OBJS_NS		= nsattr.o nsbndexp.o nsbndimp.o nsentry.o nsgroup.o nsinit.o \
		  nslookup.o nsmgmt.o nsp.o nsprofile.o nstower.o nsutil.o  \
		  nsuuid.o codesets_cstub.o ns_s_attr.o
#
# Implementation of the rpc_cs_... routines.
#
.if ${TARGET_MACHINE} == "HP800" && ${ux_release} < 1000
LANGINFO	= dce_langinfo.o
.endif

.if ${TARGET_MACHINE} == "SVR4"
OBJS_CS         = cs_s_reg.o cs_s_eval.o
.else
OBJS_CS		= cs_s_eval.o cs_s_stub.o cs_s_reg.o ${LANGINFO}
.endif

#
# Implementation of the "DCE dummy" authentication service.  Excludable
# if the AUTH_DUMMY cpp symbol is not defined (e.g., in the definition
# of AUTH_DEFS below).  Currently commented out because of bugs.
#
#OBJS_NOAUTH	= noauth.o noauthdg.o noauthcn.o
#
# Implementation of the "DCE private" authentication service.  Excludable
# if the AUTH_KRB cpp symbol is not defined (e.g., in the definition
# of AUTH_DEFS below).
#
OBJS_KRB_DG	= krbdgclt.o krbdgcom.o krbdgsrv.o 
OBJS_KRB_CN	= krbcn.o
OBJS_KRB	= krbclt.o krbcom.o krbcrc.o krbreq.o ${OBJS_KRB_DG} ${OBJS_KRB_CN}

#
# The rest of the makefile is "private" for use when building in this director
#
.if !defined(LIBDCE_LIBRARY_MAKEFILE)
#
# The following definitions are for shared libraries:
#   OBJECTS must be defined to pull in the common rules for compilation
#   LIBS    must be defined to prevent -ldce from appearing on compile lines
#
OBJECTS =
LIBS    =
.if ${SITE} == "HP" && ${TARGET_OS} == "HPUX"
TARGET_LIBS =

.ifdef LIBCMA_SL
libnck.sl_LIBS		?= -lcma
libnck.sl_SHLDFLAGS	?= -b ${LIBDIRS}
.endif	# LIBCMA_SL
.endif	# SITE == "HP" && TARGET_OS == "HPUX"

VPATH		= ../sys_idl:${TARGET_MACHINE}

INCFLAGS	= -I${TARGET_MACHINE}

#
# Don't want to build any '.a' here if we are using shared libraries
#
.if ${USE_SHARED_LIBRARIES} == 0
  LIBRARIES     =  libnck.a
.endif

.if ${SITE} == "HP" && ${TARGET_OS} == "HPUX"
.if ${USE_SHARED_LIBRARIES} != 0
SHARED_LIBRARIES	= libnck.sl
.endif
EXPSHLIB_TARGETS	= ${libnck_OFILES} ${SHARED_LIBRARIES:S/^/export_/g}
.else
EXPSHLIB_TARGETS	= ${libnck_OFILES}
.endif	# SITE == "HP" && TARGET_OS == "HPUX"

EXPDIR		= /usr/lib/

#
# The cpp symbols defined below must match the OBJ_... defined above.
# See comments above.  Note that in general these cpp symbols should
# NOT be #define'd in source code since that makes it harder to override
# things (i.e., source files need to be edited rather than "make" command
# line options changed).  This rule is not followed universally,
# unfortunately so beware of stray #define's.
#
# Note re: AUTH_DEFS -- If only AUTH_KRB is defined, then Kerberos support
# for both RPC/CN and RPC/DG is enabled.  However, if just one of
# AUTH_KRB_DG or AUTH_KRB_CN is defined (in conjuction with AUTH_KRB),
# only support for the specified RPC protocol is enabled.  (If AUTH_KRB
# is not defined, NO Kerberos support is enabled.)
#
PROT_DEFS	?= -DPROT_NCADG -DPROT_NCACN 
NAF_DEFS	?= -DNAF_IP
CDS_DEFS	?= -DDNS_CDS -DDNSPI_V3 -DDNS_V3API 
.ifndef DES_HIDDEN
AUTH_DEFS	?= -DAUTH_KRB
.else
AUTH_DEFS       ?= -DAUTH_KRB -DNOENCRYPTION
.endif
SVC_DEFS	?= -DDCE_RPC_SVC
#
# Defining the DEBUG cpp symbol causes the runtime to be built with the
# ability to produce large amounts of debug output.  (See
# "src/rpc/runtime/rpcdbg.[ch]".) It is recommended that one define DEBUG
# during debugging.
DEBUG_DEFS	?= -DDEBUG

CFLAGS		= -DNCK ${PROT_DEFS} ${AUTH_DEFS} ${NAF_DEFS} ${CDS_DEFS} \
		  ${NOENCRYPTION} \
		  ${RRPC_DEF} ${SVC_DEFS} \
		  ${${TARGET_MACHINE}_CFLAGS} ${DEBUG_DEFS}

ipnaf_sys.o_CFLAGS	= ${CFLAGS} ${${TARGET_MACHINE}_ipnaf_sys}
socki_15.o_CFLAGS	= ${CFLAGS} ${${TARGET_MACHINE}_socki_15}
sock_15.o_CFLAGS	= ${CFLAGS} ${${TARGET_MACHINE}_sock_15}
krbreq.o_CFLAGS		= ${CFLAGS} ${${TARGET_MACHINE}_krbreq}
error_15.o_CFLAGS	= ${CFLAGS} -DBSD
u_pfm_15.o_CFLAGS	= ${CFLAGS} -DBSD
lb_15.o_CFLAGS		= ${CFLAGS} -DBSD
llb_15.o_CFLAGS		= ${CFLAGS} -DBSD
glb_15.o_CFLAGS		= ${CFLAGS} -DBSD

conv_cstub.o_CFLAGS	= ${${TARGET_MACHINE}_CFLAGS}
conv_sstub.o_CFLAGS	= ${${TARGET_MACHINE}_CFLAGS} -D_DCE_INSTR_
convc_cstub.o_CFLAGS	= ${${TARGET_MACHINE}_CFLAGS}
convc_sstub.o_CFLAGS	= ${${TARGET_MACHINE}_CFLAGS} -D_DCE_INSTR_
ep_cstub.o_CFLAGS	= ${${TARGET_MACHINE}_CFLAGS}
mgmt_cstub.o_CFLAGS	= ${${TARGET_MACHINE}_CFLAGS}
mgmt_sstub.o_CFLAGS	= ${${TARGET_MACHINE}_CFLAGS} -D_DCE_INSTR_
rrpc_sstub.o_CFLAGS	= ${${TARGET_MACHINE}_CFLAGS} -D_DCE_INSTR_
codesets_cstub.o_CFLAGS	= ${${TARGET_MACHINE}_CFLAGS}

IDLFILES	= conv.idl convc.idl ep.idl mgmt.idl rrpc.idl codesets.idl

#IDLFLAGS	= -keep object -no_cpp -v -cepv -no_mepv \
#		  -cc_opt "${${TARGET_MACHINE}_CFLAGS}" 
IDLFLAGS	= -keep c_source no_cpp -cepv -no_mepv 
codesets.idl_IDLFLAGS =	${IDLFLAGS:S/-cepv//g}

.include <${RULES_MK}>

.if exists(${TARGET_MACHINE}/machdep.mk)
.include "${TARGET_MACHINE}/machdep.mk"
.endif

conv_cstub.o:			conv.idl
convc_cstub.o convc_sstub.o:	convc.idl
ep_cstub.o:			ep.idl
mgmt_cstub.o mgmt_sstub.o:	mgmt.idl
rrpc_sstub.o:			rrpc.idl
codesets_cstub.o:		codesets.idl
ns_s_attr.o: 			codesets.h

.endif


